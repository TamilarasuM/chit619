name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18.x'

jobs:
  # Detect changes to optimize CI
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'package.json'
              - 'package-lock.json'
            frontend:
              - 'frontend/**'

  # Backend validation
  backend-checks:
    name: Backend Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check code formatting
        run: npx prettier --check "backend/**/*.js"
        continue-on-error: true

      - name: Run ESLint
        run: npx eslint backend/
        continue-on-error: true

      - name: Run tests with coverage
        run: npm test -- --coverage
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test
          JWT_SECRET: test-secret-key-for-ci-only

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: backend
          name: backend-coverage
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          if grep -r -i -E "(password|secret|api[_-]?key|token)\s*=\s*['\"][^'\"]+['\"]" backend/ --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è Potential secrets found in code!"
            exit 1
          fi
        continue-on-error: true

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Frontend validation
  frontend-checks:
    name: Frontend Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Check code formatting
        run: |
          cd frontend
          npx prettier --check "src/**/*.{js,jsx}"
        continue-on-error: true

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Type checking (if TypeScript)
        run: |
          cd frontend
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          else
            echo "No TypeScript config found, skipping type check"
          fi
        continue-on-error: true

      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: https://api.example.com/api

      - name: Check bundle size
        run: |
          cd frontend
          if [ -d "dist" ]; then
            echo "üì¶ Bundle size:"
            du -sh dist
            find dist -name "*.js" -exec ls -lh {} \; | awk '{print $5, $9}'
          fi

      - name: Security audit
        run: |
          cd frontend
          npm audit --audit-level=moderate
        continue-on-error: true

  # PR size check
  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)')
          DELETIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletion)')

          echo "üìä PR Statistics:"
          echo "Files changed: $CHANGED_FILES"
          echo "Lines added: ${ADDITIONS:-0}"
          echo "Lines deleted: ${DELETIONS:-0}"

          if [ $CHANGED_FILES -gt 50 ]; then
            echo "‚ö†Ô∏è Warning: Large PR with $CHANGED_FILES files"
            echo "Consider breaking this into smaller PRs for easier review"
          fi

  # Comment PR with results
  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [backend-checks, frontend-checks, pr-size-check]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const backendStatus = '${{ needs.backend-checks.result }}';
            const frontendStatus = '${{ needs.frontend-checks.result }}';

            let body = '## ü§ñ PR Validation Results\n\n';

            if (backendStatus !== 'skipped') {
              body += `- Backend: ${backendStatus === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}\n`;
            }
            if (frontendStatus !== 'skipped') {
              body += `- Frontend: ${frontendStatus === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}\n`;
            }

            body += '\n---\n';
            body += 'Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
