name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to rollback'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  rollback-confirmation:
    name: Rollback Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Log rollback request
        run: |
          echo "‚ö†Ô∏è ROLLBACK REQUESTED"
          echo "Target: ${{ github.event.inputs.target }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Requested by: ${{ github.actor }}"
          echo "Time: $(date)"

  rollback-backend:
    name: Rollback Backend
    runs-on: ubuntu-latest
    needs: rollback-confirmation
    if: github.event.inputs.target == 'backend' || github.event.inputs.target == 'both'
    environment:
      name: production-backend

    steps:
      - name: Rollback via Render
        run: |
          echo "üîÑ Rolling back backend..."
          echo "Manual action required:"
          echo "1. Go to Render Dashboard: https://dashboard.render.com"
          echo "2. Select your backend service"
          echo "3. Go to 'Events' tab"
          echo "4. Find the previous successful deployment"
          echo "5. Click 'Redeploy' on that version"
          echo ""
          echo "Reason: ${{ github.event.inputs.reason }}"

      - name: Notify team
        run: |
          echo "üì¢ Backend rollback initiated"
          echo "Reason: ${{ github.event.inputs.reason }}"

  rollback-frontend:
    name: Rollback Frontend
    runs-on: ubuntu-latest
    needs: rollback-confirmation
    if: github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both'
    environment:
      name: production-frontend

    steps:
      - name: Rollback via Vercel
        run: |
          echo "üîÑ Rolling back frontend..."
          echo "Manual action required:"
          echo "1. Go to Vercel Dashboard: https://vercel.com/dashboard"
          echo "2. Select your project"
          echo "3. Go to 'Deployments' tab"
          echo "4. Find the last working deployment"
          echo "5. Click '...' menu ‚Üí 'Promote to Production'"
          echo ""
          echo "Reason: ${{ github.event.inputs.reason }}"

      - name: Notify team
        run: |
          echo "üì¢ Frontend rollback initiated"
          echo "Reason: ${{ github.event.inputs.reason }}"

  create-incident-issue:
    name: Create Incident Issue
    runs-on: ubuntu-latest
    needs: [rollback-backend, rollback-frontend]
    if: always()
    permissions:
      issues: write

    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üö® Production Rollback Incident

            **Target:** ${{ github.event.inputs.target }}
            **Reason:** ${{ github.event.inputs.reason }}
            **Initiated by:** @${{ github.actor }}
            **Time:** ${new Date().toISOString()}

            ### Required Actions

            - [ ] Verify rollback completed successfully
            - [ ] Investigate root cause
            - [ ] Create fix
            - [ ] Test fix in staging
            - [ ] Document incident
            - [ ] Update monitoring/alerts if needed

            ### Rollback Status

            - Backend: ${{ needs.rollback-backend.result }}
            - Frontend: ${{ needs.rollback-frontend.result }}

            ### Next Steps

            1. Verify services are stable
            2. Investigate the issue
            3. Prepare a fix
            4. Deploy fix when ready

            ---
            *Auto-generated by rollback workflow*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Rollback: ${new Date().toISOString().split('T')[0]} - ${{ github.event.inputs.target }}`,
              body: body,
              labels: ['incident', 'rollback', 'urgent']
            });
