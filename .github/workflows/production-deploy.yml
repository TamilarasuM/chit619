name: Production Deployment

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  RENDER_BACKEND_URL: 'https://chitfund-backend-o5px.onrender.com'
  VERCEL_FRONTEND_URL: 'https://frontend-five-topaz-22.vercel.app'

jobs:
  # Detect which parts of the codebase changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'package.json'
              - 'package-lock.json'
              - 'render.yaml'
              - 'render-build.sh'
              - '.env.example'
            frontend:
              - 'frontend/**'

  # Backend tests and security checks
  backend-test:
    name: Backend Tests & Security
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run backend tests
        run: npm test
        env:
          NODE_ENV: test
          MONGODB_URI: ${{ secrets.MONGODB_URI_TEST }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Check for vulnerabilities
        run: npx snyk test --severity-threshold=high
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # Frontend build and tests
  frontend-build:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Lint frontend code
        run: |
          cd frontend
          npm run lint
        continue-on-error: true

      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # Deploy backend to Render
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-test]
    if: needs.detect-changes.outputs.backend == 'true' && success()
    environment:
      name: production-backend

    steps:
      - name: Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: Wait for deployment
        run: sleep 60

      - name: Health check
        run: |
          MAX_RETRIES=10
          RETRY_COUNT=0
          HEALTH_URL="${{ env.RENDER_BACKEND_URL }}/health"

          echo "Checking health endpoint: $HEALTH_URL"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Backend is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "⏳ Attempt $RETRY_COUNT/$MAX_RETRIES - HTTP $HTTP_CODE - Retrying in 10s..."
            sleep 10
          done

          echo "❌ Backend health check failed after $MAX_RETRIES attempts"
          exit 1

  # Deploy frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: [detect-changes, frontend-build]
    if: needs.detect-changes.outputs.frontend == 'true' && success()
    environment:
      name: production-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: frontend

      - name: Build with Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: frontend

      - name: Verify deployment
        run: |
          sleep 20
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.VERCEL_FRONTEND_URL }}" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Frontend is live (HTTP $HTTP_CODE)"
          else
            echo "⚠️ Frontend returned HTTP $HTTP_CODE"
            exit 1
          fi

  # Deployment notification
  notify-deployment:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Send deployment status
        run: |
          if [ "${{ needs.deploy-backend.result }}" = "success" ] || [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "✅ Deployment completed successfully"
            echo "Backend: ${{ needs.deploy-backend.result }}"
            echo "Frontend: ${{ needs.deploy-frontend.result }}"
          else
            echo "❌ Deployment failed"
            echo "Backend: ${{ needs.deploy-backend.result }}"
            echo "Frontend: ${{ needs.deploy-frontend.result }}"
            exit 1
          fi
